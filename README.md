# OptSim2 - 光学シミュレーションソフトウェア

手書きの図形を認識して、光の屈折・反射をシミュレートするインタラクティブなソフトウェアです。

## 特徴

- **2画面表示**: 横図（側面図）と上面図（真上から）を同時表示
- **リアルタイム光線追跡**: スネルの法則に基づいた正確な屈折計算
- **光強度ヒートマップ**: 球に当たった光の強度を色で可視化（青→緑→黄→赤）
- **ズーム＆パン機能**: マウスホイールでズーム、右クリックドラッグで平行移動
- **インタラクティブ操作**: 光源をドラッグして移動、角度・広がり・水面の位置を調整可能
- **手書き図形認識**: OpenCVを使用して手書きの図形を検出（将来実装予定）

## シミュレーション内容

- 空気から水への光の屈折
- 水中の球による反射・光強度分布
- 50本の光線による詳細な光の経路可視化
- 横図と上面図の同時表示と連動

## インストール

### 必要環境

- Python 3.12以上
- uv (Pythonパッケージマネージャー)

### セットアップ

```bash
# リポジトリをクローン
git clone <repository-url>
cd OptSim2

# uvで依存関係をインストール（既に実行済みの場合は不要）
uv sync
```

## 使い方

### シミュレーションの起動

```bash
uv run optsim2
```

または

```bash
uv run python -m optsim2.main
```

### 操作方法

#### マウス操作
- **左クリック + ドラッグ**: 光源（黄色い円）を移動
- **マウスホイールクリック + ドラッグ**: ビューを平行移動（パン）※拡大時のみ有効
- **マウスホイール**: ズームイン/ズームアウト（各ビュー独立）
  - ホイール上: 拡大（最大3倍）
  - ホイール下: 縮小（最小0.5倍）

#### キーボード操作
- **上矢印キー**: 水面を上げる
- **下矢印キー**: 水面を下げる
- **左矢印キー**: 光の角度を左に回転（10度ずつ）
- **右矢印キー**: 光の角度を右に回転（10度ずつ）
- **Q キー**: 光の広がり角度を狭くする
- **E キー**: 光の広がり角度を広くする
- **R キー**: シミュレーションをリセット
- **ESC キー**: 終了

### 画面の見方

#### 左側: 横図（側面図）
- 上部の薄青色領域: 空気
- 下部の青色領域: 水
- 黄色い円: 光源（ハロゲンランプ）
- オレンジの線: 光線の経路
- カラフルな円: 球（光強度に応じて色が変化）
  - 青: 光が弱い/当たっていない
  - 緑: 中程度の光
  - 黄: 強い光
  - 赤: 非常に強い光

#### 右側: 上面図（真上から）
- 青色の領域: 水面を真上から見た様子
- 黄色い矩形: ハロゲンランプ（真上から見た形状）
- 縦の線: 光線（上から下に向かう）
- 赤い円: 球の位置
- **注意**: 横図で光源を上下に動かすと、上面図では光源と球の距離が変化します

## プロジェクト構造

```
OptSim2/
├── src/
│   └── optsim2/
│       ├── __init__.py
│       ├── main.py              # メインアプリケーション
│       ├── optics_engine.py     # 光学シミュレーションエンジン
│       └── shape_detector.py    # 手書き図形認識（今後の拡張用）
├── 29982.jpg                    # サンプル手書き図形
├── pyproject.toml              # プロジェクト設定
├── uv.lock                     # 依存関係ロック
└── README.md                   # このファイル
```

## 技術詳細

### 光学エンジン

- **スネルの法則**: `n1 * sin(θ1) = n2 * sin(θ2)` を使用した屈折計算
- **屈折率**: 空気 n=1.0、水 n=1.33
- **全反射**: 臨界角を超えた場合の全反射を実装
- **光線追跡**: 最大5回の反射・屈折を追跡
- **光強度計算**: 球表面の360度すべての角度で光強度を計算し、ヒートマップ表示

### 使用技術

- **Python 3.12+**: メイン言語
- **Pygame**: グラフィックス・GUI・イベント処理
- **NumPy**: 数値計算・ベクトル演算・角度計算
- **OpenCV**: 画像処理（図形認識用）
- **Pillow**: 画像ファイル操作
- **SciPy**: 科学技術計算
- **uv**: 高速パッケージ管理

### 描画機能

- **ズーム**: 0.5倍～3倍の範囲で拡大縮小
- **パン**: 拡大時に右クリックドラッグで表示位置を移動
- **ヒートマップ**: 球を360個の扇形に分割し、各角度の光強度を色で表現
- **日本語フォント**: Meiryo/MS Gothicフォントで日本語表示対応

## 今後の拡張予定

- [ ] 手書き図形認識の完全統合
- [ ] より多様な光学素子（レンズ、プリズムなど）
- [ ] 3D表示モード
- [ ] シミュレーション結果のエクスポート（画像・CSV）
- [ ] より詳細な物理パラメータの調整UI
- [ ] 複数の球や障害物の追加機能
- [ ] アニメーション記録機能

## ライセンス

MIT License

## 作成者

Claude Code による実装
