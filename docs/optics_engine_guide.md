# 光学エンジン（optics_engine.py）解説書
## 初学者向けガイド

---

## 📖 このファイルは何をするの？

`optics_engine.py` は、**光の動きをシミュレーションするプログラム**です。

現実の世界では、光が水面に当たると曲がったり（屈折）、鏡に跳ね返ったり（反射）します。このプログラムは、その物理現象を計算で再現します。

---

## 🎯 このファイルの役割

```
┌─────────────────────────────────────────────────────────┐
│                    main.py                              │
│              （画面表示・ユーザー操作）                     │
└─────────────────────────────────────────────────────────┘
                          ↓ 「光の計算をして」
┌─────────────────────────────────────────────────────────┐
│                optics_engine.py  ← このファイル          │
│              （光の物理計算を担当）                        │
│                                                          │
│  ・光線を作る                                             │
│  ・水面での屈折を計算する                                  │
│  ・球に当たった反射を計算する                              │
└─────────────────────────────────────────────────────────┘
                          ↓ 「計算結果（光の経路）」
┌─────────────────────────────────────────────────────────┐
│                    main.py                              │
│              （結果を画面に描画）                          │
└─────────────────────────────────────────────────────────┘
```

---

## 📦 クラスの説明

### 1️⃣ Ray クラス（光線）

**「1本の光」を表すクラス**

```python
class Ray:
    def __init__(self, origin, direction, intensity=1.0):
```

#### 持っている情報

| 変数名 | 意味 | 例 |
|--------|------|-----|
| `origin` | 光線の現在位置 | `[100, 50, 0]` (x, y, z座標) |
| `direction` | 光が進む方向 | `[0, 1, 0]` (下向き) |
| `intensity` | 光の明るさ | `1.0` (最大) 〜 `0.0` (消滅) |
| `path` | 光が通った経路 | `[[100,50], [100,100], ...]` |

#### メソッド

| メソッド | 意味 |
|----------|------|
| `propagate(distance)` | 光を指定した距離だけ進める |

```python
# 例：光を100ピクセル進める
ray.propagate(100)
```

---

### 2️⃣ OpticsEngine クラス（光学エンジン本体）

**シミュレーション全体を管理するクラス**

```python
class OpticsEngine:
    N_AIR = 1.0    # 空気の屈折率
    N_WATER = 1.33  # 水の屈折率
```

---

## 🔧 主要メソッドの解説

### 📍 add_ball() - 球を追加する

```python
def add_ball(self, position, radius):
```

**何をする？** シミュレーション空間に球（ボール）を配置します。

**使い方**
```python
engine = OpticsEngine()
engine.add_ball((400, 500, 0), radius=50)  # 位置(400,500,0)に半径50の球を追加
```

---

### 📐 refract() - 屈折を計算する

```python
def refract(self, incident, normal, n1, n2):
```

**何をする？** スネルの法則を使って、光が曲がる方向を計算します。

**引数の意味**
| 引数 | 意味 |
|------|------|
| `incident` | 入ってくる光の方向 |
| `normal` | 境界面に垂直な方向（法線） |
| `n1` | 光が来る側の屈折率（例：空気=1.0） |
| `n2` | 光が進む側の屈折率（例：水=1.33） |

**戻り値**
- 屈折後の光の方向
- 全反射の場合は `None`（光が曲がれない）

**イメージ図**
```
      入射光 ↘
              │ ← 法線（normal）
    ═══════════════ ← 水面
              │
              ↘ 屈折光
```

---

### 🪞 reflect() - 反射を計算する

```python
def reflect(self, incident, normal):
```

**何をする？** 光が鏡のように跳ね返る方向を計算します。

**公式**
```
反射光 = 入射光 - 2 × (入射光・法線) × 法線
```

**イメージ図**
```
    入射光 ↘     ↗ 反射光
              球
```

---

### ⚪ intersect_sphere() - 球との交点を計算

```python
def intersect_sphere(self, ray, ball):
```

**何をする？** 光線が球にぶつかるかどうか、ぶつかるなら何ピクセル先かを計算します。

**戻り値**
- `(距離, 法線ベクトル)` : ぶつかる場合
- `None` : ぶつからない場合

**内部で使う公式（二次方程式）**
```
at² + bt + c = 0

a = 光線の方向ベクトルの長さの2乗
b = 2 × (光線の始点から球の中心へのベクトル) ・ (光線の方向)
c = (光線の始点から球の中心へのベクトル)² - 球の半径²
```

---

### 🌊 intersect_water_surface() - 水面との交点を計算

```python
def intersect_water_surface(self, ray):
```

**何をする？** 光線が水面にぶつかる位置を計算します。

**水面の定義**
- Y座標が `water_level` の水平面

---

### 🔍 trace_ray() - 光線を追跡する（メイン処理）

```python
def trace_ray(self, ray, max_bounces=5):
```

**何をする？** 1本の光線を追いかけて、すべての屈折・反射を計算します。

**処理の流れ**
```
1. 光線の現在位置から最も近い障害物を探す
   ↓
2. 水面か球か判定
   ↓
3. 水面の場合 → 屈折を計算（または全反射）
   球の場合 → 反射を計算
   ↓
4. 光線の方向を更新し、経路を記録
   ↓
5. 強度が弱くなるまで、または最大回数まで繰り返し
```

**max_bounces とは？**
- 光が跳ね返る最大回数（デフォルト5回）
- これがないと無限ループになる可能性がある

---

### 💡 create_light_source() - 2D光源を作成

```python
def create_light_source(self, position, num_rays=20, spread_angle=π/3, center_angle=0.0):
```

**何をする？** 1点から複数の光線を扇形に発射します。

**引数の意味**
| 引数 | 意味 | 例 |
|------|------|-----|
| `position` | 光源の位置 | `(300, 100)` |
| `num_rays` | 光線の本数 | `20` |
| `spread_angle` | 扇の開き角度（ラジアン） | `π/3`（60度） |
| `center_angle` | 扇の中心方向 | `0`（真下） |

**イメージ図**
```
         ☀ ← 光源
        /│\
       / │ \    ← spread_angle（広がり角度）
      /  │  \
     ↙  ↓  ↘   ← num_rays本の光線
```

---

### 💡 create_light_source_3d() - 3D光源を作成

```python
def create_light_source_3d(self, position, num_rays_radial=20, num_rays_circular=12, ...):
```

**何をする？** 3D空間で円錐状に光線を発射します。

**イメージ**
```
            ☀ ← 光源
           /|\
          ╱ │ ╲
         ╱  │  ╲
        ╱   │   ╲    ← 円錐状に広がる
       ╱────@────╲   ← 円形の断面
```

---

### 🌊 get_water_normal_with_ripple() - 水面のゆらぎ

```python
def get_water_normal_with_ripple(self, x, z):
```

**何をする？** 波のある水面の法線（傾き）を計算します。

**なぜ必要？**
- 静かな水面は完全に平らなので光は均一に屈折
- 波がある水面は位置によって傾きが違うので、光がバラバラに屈折

**計算方法**
- 複数のサイン波を重ね合わせて自然な波を再現

---

## 📊 物理定数

| 定数名 | 値 | 意味 |
|--------|-----|------|
| `N_AIR` | 1.0 | 空気の屈折率 |
| `N_WATER` | 1.33 | 水の屈折率 |

---

## 🔢 屈折率について

屈折率（n）は「その物質の中で光がどれだけ遅くなるか」を表します。

| 物質 | 屈折率 | 光の速さ |
|------|--------|---------|
| 真空 | 1.000 | 最速 |
| 空気 | 1.000 | ほぼ最速 |
| 水 | 1.333 | 真空の約75% |
| ガラス | 1.5 | 真空の約67% |

**n が大きい物質に入ると、光は法線に近づく方向に曲がる！**

---

## 📝 まとめ

| クラス/メソッド | 一言で言うと |
|----------------|-------------|
| `Ray` | 1本の光を表すデータ |
| `OpticsEngine` | 光学シミュレーターの本体 |
| `refract()` | スネルの法則で屈折計算 |
| `reflect()` | 反射方向の計算 |
| `trace_ray()` | 光を追跡して経路を記録 |
| `create_light_source()` | 複数の光線を生成 |

---

## ❓ よくある質問

### Q. 全反射って何？
光が水から空気に出ようとするとき、角度が浅すぎると出られなくなり、水中に跳ね返されます。これが全反射です。臨界角（水の場合約48.6°）を超えると起こります。

### Q. なぜ intensity が減っていくの？
現実の光も、反射するたびに一部が吸収されて弱くなります。シミュレーションでは `*= 0.8` や `*= 0.95` で再現しています。

### Q. path にはどんなデータが入るの？
光が通過したすべての点の座標リストです。これを使って画面に光線を描画します。
```python
ray.path = [[100,50], [100,200], [150,300], [200,400]]
#           始点     水面       球の表面   反射後
```
